# 1.3 Azure AI Template

!!! note "The Azure AI Foundry [Code Preview](https://ai.azure.com/build/code) tab in an active Azue AI project will list 3 azd-capable templates, one of which is the [Get started with Azure AI](https://github.com/Azure-Samples/azureai-basic-python) basic starter template. We'll use this as our reference in this tutorial."

## 1. Before We Begin

Let's look at what our default folder structure looks like. You should see the following. Make note of this so we can identify the new folders/files that get added when we "azd init" the repo.

```bash title=""
.devcontainer/   # Launch pre-build dev environment in GitHub Codespaces
.github/         # Add workflows for automated CI/CD actions
data/            # Contains data for AI application needs
docs/            # Contains documentation for AI application workshop
src.sample/      # Contains app code (working sample)
env.sample/      # Contains env variables (placeholder sample)
.gitignore       # Contains .gitignore rules
LICENSE          
mkdocs.yml       # Configuration for mkdocs documentation site
README.md        # README for repo
REFERENCES.md    # REFERENCES for repo
requirements.txt # Python dependencies for application

```

## 2. View AI Template

Let's take a look at what the folder structure for the [Get started with Azure AI](https://github.com/Azure-Samples/azureai-basic-python) basic starter template looks like by visiting that repo:

```bash title=""
.azdo/pipelines/        # Azure DevOps pipelines 
.devcontainer/          # Dev Container configuration
.github/                # GitHub Actions workflows
docs/                   # README assets and docs
infra/                  # Infrastructure-as-code assets
scripts/                # Scripts for azd hooks 
src/                    # Application source
.gitignore
.pre-commit-config.yaml # Pre-commit hooks: code quality checks
LICENSE
README.md
azure.yaml               # Azure Developer CLI configuration
pyproject.toml           # Python Project configuration
requirements-dev.txt     # Python Project package dependencies
```

## 3. Initialize Template

To use that template, we need to run the right azd command in our repo.

### 3.1 Create Sandbox 
 Let's see what happens when we run this at the root of our existing folder:

```bash title=""
azd init -t azureai-basic-python
```

You should see a warning like this:

```bash title=""
Initializing an app to run on Azure (azd init)

WARNING: The current directory is not empty.
Initializing an app in this directory may overwrite existing files.

? Continue initializing an app in '/workspaces/azure-ai-rag-workshop'? (y/N) 
```

We don't want this to happen since we are using the `.devcontaine/`, `.github/`, `LICENSE`, `README.md` and `docs/` filenames for our own content. Instead, let's see what happens when we run this in a _sandbox_ directory. We can then compare the contents and move them into the root folder in a more informed manner.

```bash title=""
mkdir Smkdir SANDBOXANDBOX
```
```bash title=""
cd SANDBOX/
```

### 3.2 Run `azd init`
```bash title=""
azd init -t azureai-basic-python
```

You now see something like this:

```bash title=""

Initializing an app to run on Azure (azd init)
  (âœ“) Done: Downloading template code to: /workspaces/azure-ai-rag-workshop/SANDBOX

? Enter a new environment name: [? for help] 
```

At this point, if you view the `SANDBOX/` folder in the explorer sidebar on VS Code, you will see the file structure from [the template view](#2-view-ai-template) replicated here, along with an empty `.azure/` folder.

### 3.3 Complete init

Let's continue with the `azd init` wizard workflow by providing an environment name. Let's pick _ragchat-aip_ as a symbolic name for the RAG Chat app on the Azure AI Platform. You should now see this:

```bash title=""
? Enter a new environment name: ragchat-aip

SUCCESS: New project initialized!        
You can view the template code in your directory: /workspaces/azure-ai-rag-workshop/SANDBOX
Learn more about running 3rd party code on our DevHub: https://aka.ms/azd-third-party-code-notice
```

If you look in the `SANDBOX/` folder you will now see the `.azure/` folder is updated:

```bash title=""
.azure/
    ragchat-aip/
        .env             # has: AZURE_ENV_NAME="ragchat-aip"
        config.json      # is empty
    .gitignore
    config.json          # has: {"version":1,"defaultEnvironment":"ragchat-aip"}
```

### 3.4 Merge Sandbox

We can now merge the contents from `SANDBOX/` into the root of the folder in a way that preserves pre-existing files:

```bash title=""
cd SANDBOX/
mv .azdo .azure ../.
mv README.md ../README.azd.md
mv docs/* ../.
mv infra scripts src .pre-commit-config.yaml azure.yaml pyproject.toml requirements-dev.txt .gitignire ../.
mv .github/* ../.github/
mv .github/workflows/* ../.github/workflows
```

Now we need to make a few fixes:

- Update the `README.azd.md` to point to the right location (root) for the two files that were in the docs/ directory but are now at root level - so they resolve correctly.
- Add these two lines to the end of `.gitignore` 
  ```bash title=""
  # From RAG Chat
  site/
  .DS_Store
  ```

All that is left is the `.devcontainer.json` reconciliation. For convenience, just copy these files into the relevant files in `.devcontainer/` 

??? note "Expand for contents to copy into `.devcontainer/devcontainer.json`"

    ```json title="devcontainer.json"
    // Dev Container:
    // Format: https://aka.ms/devcontainer.json. 
    // Config: https://github.com/devcontainers/templates/tree/main/src/python
    // Dockerfile Usage: https://containers.dev/guide/dockerfile
    {
        "name": "azureai-ragchat-azd",
        "build": {
            "dockerfile": "Dockerfile",
            "context": ".."
        },
        "features": {
            "ghcr.io/devcontainers/features/azure-cli:1": {
                "installBicep": true,
                "extensions": "ml"
            },
            "ghcr.io/devcontainers/features/git:1": {},
            "ghcr.io/azure/azure-dev/azd:latest": {},
            "ghcr.io/devcontainers/features/docker-in-docker:2": {},
            "ghcr.io/devcontainers/features/github-cli:1": {},
            "ghcr.io/devcontainers/features/node:1": {
                "version": "22.8.0"
            }
        },
        "customizations": {
            "vscode": {
                "extensions": [
                    "ms-azuretools.azure-dev",
                    "ms-azuretools.vscode-bicep",
                    "ms-python.python",
                    "ms-toolsai.jupyter",
                    "GitHub.vscode-github-actions",
                    "ms-toolsai.prompty@prerelease"
                ]
            }
        },
        "postCreateCommand": "bash .devcontainer/post-create.sh",
        "forwardPorts": [
            8000,
            50505
        ],
        "remoteUser": "vscode",
        "hostRequirements": {
            "memory": "8gb"
        }
    }

    ```

??? note "Expand for contents to copy into `.devcontainer/Dockerfile`"

    ```json title="Dockerfile"
    # Select base Docker image
    FROM mcr.microsoft.com/devcontainers/python:3.11-bullseye

    # Combine system & package updates into a single run command
    # Clean up apt cache to reduce image size
    RUN sudo apt-get update && sudo apt-get install -y \
        gcc \
        cmake \
        pkg-config \
        libdbus-1-dev \
        libglib2.0-dev \
    && python -m pip install --upgrade pip \
    && sudo apt-get clean \
    && sudo rm -rf /var/lib/apt/lists/*

    # Copy requirements.txt and install the Python packages
    COPY requirements.txt .
    COPY requirements-dev.txt .

    # Install key packages in one layer to reduce image size and build time
    RUN pip install -r requirements.txt \    
        && pip install keyrings.alt dbus-python ipython ipykernel mkdocs-material

    # From azd template
    RUN pip install -r requirements-dev.txt && python3 -m pip install -e  src

    # Configure the IPython kernel
    RUN ipython kernel install --name "python3" --user

    # Install daily version of azd for latest changes
    # See: https://github.com/Azure/azure-dev/tree/main/cli/installer#download-from-daily-builds
    RUN curl -fsSL https://aka.ms/install-azd.sh | bash -s -- --version daily

    # ------------ Dev Container configuration -----------------
    # Adapted from https://github.com/Azure-Samples/contoso-chat
    ```

We can now delete the `SANDBOX/` folder.


## 4. Validate Template

Let's see if our merged repository is now an active azd template before we dive in.

1. First authenticate with Azure - use the `--use-device-code` flag if running in GitHub Codespaces.

    ```bash title=""
    azd auth login --use-device-code
    ```

    Complete the workflow as instructed - you should see this on success:

    ```bash title=""
    Waiting for you to complete authentication in the browser...
    Device code authentication completed.
    ```

1. Provision and deploy template using the command below. You will be asked to select the subscription and location for deployment. It should then update the `.azure/.env` file with the relevant parameters, then create a resource group called `rg-ragchat-aip` in which it will provision the resources and deploy the app.

    ```bash title=""
    azd up
    ```

1. **Troubleshooting**: Insufficent Quota 

    - You may get an `InsufficientQuota` error if you pick the wrong location. One way to avoid this is to check [Quota](https://ai.azure.com/quota) and pick a location with available quota.
    - To fix the issue: the simplest option is to 
        - `azd down --purge` (to release all resources created), 
        - then update the `.env` file (to select location with quota). _Takes time_.
        - then `azd up` again to complete successful deploy. _Takes time_.